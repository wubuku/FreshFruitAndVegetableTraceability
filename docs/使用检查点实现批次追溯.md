# 使用检查点实现批次追溯

## 导言

本文档详细说明如何通过"检查点"机制实现生产过程中的批次追溯。在连续生产环境中，传统批次管理难以准确追踪原料、半成品与成品之间的对应关系。检查点机制通过在特定时间点对生产状态进行"快照"，建立不同物料批次之间的明确关联，从而实现精确的全链路追溯。

## 概念澄清

关键概念：
  - **检查点（CheckPoint）**：一个**时间点**（如每日零点、手动触发），用于分割连续的生产时间。在一个检查点发生时，需要确认当前车间内所有物料（半成品、成品、原料）的状态。检查点的设置可以很灵活，可以一天设置一个检查点，也可以一天设置多个检查点。还可以随时手动触发检查点。
  - **班次**：检查点之间的**时间段**。这里的班次**可以**和实际人员的换班情况不一定一致，比如可能客户不想在每次人员换班的时候都做检查。（如一天设置一个检查点，检查点为0点，那么每日0点至次日0点为一个班次；但是实际上这一天人员换了3次班。）
  - **批次号规则**：班次产出物料的批次号直接使用日期加"检查点序号"的格式（假设每天只有一个检查点，那么可以没有序号，比如使用日期`250508`表示5月8日班次）。 


## 流程示例

为了方便阐述，我们先做一些假设：
   - 假设每天只有一个检查点，检查点为0点。产出的产品的批次号我们先省略年份。其实不管每天设置多少个检查点，这个方案的原理都是一样的。
   - 支持跨班次的"生产线上物料"的结转逻辑（如下面示例的班次`0508`未用完的`234`批次的*原料番茄*，直接结转入班次`0509`使用），虽然这个逻辑可能对于某些客户来说，可能并不需要（甚至按照生产规则"禁止"出现）。
   - 我们使用三种物料：*原料番茄*、*切片番茄*（半成品）、*沙拉*（成品），来进行示例说明。

### 基本规则说明

- **班次与批次号规则**：  
  - 每个班次（如`0508`）内产出的**所有半成品、成品**均以**班次日期**作为批次号。  
  - 例：5月8日班次产出的*切片番茄*（半成品）的批次号为`0508`，*沙拉*（成品）的批次号也为`0508`。  
- **物料投入、结转与批次关联**：  
  - **投入**：一个"班次"运行期间，可以多次投入原料（如`123`、`234`批次的原料番茄）、半成品；以及上个班次遗留在线上的原料（如上个班次遗留的`234`批次的原料番茄），这类"结转"的原料，也是"投入"的一种。  
  - **产出**：可以包括半成品（`0508-切片番茄`）、成品（`0508-沙拉`）。  
  - **关联关系**：记录产出的批次与**所有投入的批次**的关联，包括结转物料。  
- **跨班次结转规则**：  
  - 检查点触发时，需要清点班次内"仍然留在线上"的未消耗的物料（如原料番茄`234`批次未用完）。  
  - 这些未消耗物料自动结转入下一班次（如原料番茄批次`234`从班次`0508`结转入班次`0509`），从而影响下一班次的"批次关联"关系。
  - 除了原料，半成品、成品在检查点发生时，需要**入库**（可以直接自动进入到车间内特定的"线边仓库"），不参与跨班次的"线上结转"。
- **确认规则**：
  - 检查点触发时，考虑人工确认介入进行确认。
  - 将（检查点之前的）当前班次的所有*投入*的物料通过 BOM 分解到最底层的原料（当前班次投入的原料*分解*后还是本身），分组累计出每种原料的数量。
  - 将当前班次所有的产出，包括半成品、成品以及（还没有使用的）原料，通过 BOM 分解到最底层的原料，分组累计出每种原材料的数量。
  - 每种原料的两个汇总数量对比，前者（投入）应该大于等于后者（产出）。
  - 如果不符合这个规则，提示用户进行纠正，比如检查是否漏掉了**投入某个批次的物料**的操作。
  - 用户纠正、确认后，检查点的状态更新（已确认），并可能执行必要的自动操作（比如自动将半成品入库到线边仓库）。

> 这个做法的简单之处是，用户“确认”时只需要重点关注*当前的*物料状态：剩下什么、数量多少；产出了什么，数量多少。
> 系统可以检查用户想要确认的**当前状态**和**历史作业记录**之间是否具有合理的联系；如果不合理，也给了用户补救的机会。


### 批次追溯流程图

```
┌────────────────┐    ┌────────────────┐    ┌────────────────┐
│    班次 0508    │    │    班次 0509    │    │    班次 0510    │
└────────┬───────┘    └────────┬───────┘    └────────┬───────┘
         │                     │                     │
         ▼                     ▼                     ▼
┌────────────────┐    ┌────────────────┐    ┌────────────────┐
│     投入:       │    │     投入:       │    │     投入:      │
│  原料番茄123    │    │  结转原料234     │    │  原料番茄456    │
│  原料番茄234    │    │  原料番茄345     │    │ 半成品切片番茄   │
│                │    │                │    │     0508       │
└────────┬───────┘    └────────┬───────┘    └────────┬───────┘
         │                     │                     │
         ▼                     ▼                     ▼
┌────────────────┐    ┌────────────────┐    ┌────────────────┐
│     产出:       │    │     产出:       │    │     产出:      │
│ 半成品切片番茄   │    │  成品沙拉0509    │    │  成品沙拉0510   │
│     0508       │    │                │    │                │
│ 成品沙拉0508    │    │                │     │               │
└────────┬───────┘    └────────┬───────┘    └────────┬───────┘
         │                     │                     │
         ▼                     ▼                     ▼
┌────────────────┐    ┌────────────────┐    ┌────────────────┐
│     结转:       │    │     结转:       │    │   追溯关系:     │
│  原料番茄234    │    │     无结转      │    │直接: 456, 0508  │
│  (部分未用完)   │    │                │    │间接: 123, 234   │
└────────────────┘    └────────────────┘    └────────────────┘
```


下面我们以连续运行的3个班次为例，来阐述这个方案。


### **第一个检查点之前：班次0508（5月8日）**

1. **投入**：  
   - 原料：原料番茄批次`123`（耗尽）、原料番茄批次`234`（部分使用）。  
   - 假设没有之前班次遗留的原料番茄批次，也没有投入任何半成品。
    
2. **检查点触发（零点）**：  
   - 产出：番茄切片半成品`0508`、沙拉成品`0508`。  
   - 系统记录：  
     - `0508`半成品/成品 ← `123`（耗尽）、`234`（部分结余）。  
   - 结余物料：原料番茄批次`234`剩余部分。  
    
3. **结转操作**：  
   - 剩余原料番茄批次`234`自动进入下一班次`0509`的投入列表。  

4. **关联表记录**：

    | 投入批次 | 产出批次 | 类型                      | 关联的来源班次 |
    | -------- | -------- | ------------------------- | -------------- |
    | 123      | 0508     | 原料番茄→半成品番茄切片 | 0508           |
    | 234      | 0508     | 原料番茄→半成品番茄切片 | 0508           |
    | 123      | 0508     | 原料番茄→成品沙拉       | 0508           |
    | 234      | 0508     | 原料番茄→成品沙拉       | 0508           |

### **第二个检查点之前：班次0509（5月9日）**

1. **投入**：  
   - 结转原料：原料番茄批次`234`（来自班次`0508`）。  
   - 新原料：原料番茄批次`345`（当期投入）。  
    
2. **检查点触发（零点）**：  
   - 产出：成品沙拉`0509`。  
   - 系统记录：  
     - `0509`成品 ← `234`（结转批次）、`345`（新批次）。  
    
3. **追溯验证**：  
   - 查询`0509`成品，可追溯至原料番茄批次`234`（源头为班次`0508`）和原料番茄批次`345`。  

4. **关联表记录**：

    | 投入批次 | 产出批次 | 类型                    | 关联的来源班次 |
    | -------- | -------- | ----------------------- | -------------- |
    | 234      | 0509     | 结转原料番茄→成品沙拉 | 0509           |
    | 345      | 0509     | 新原料番茄→成品沙拉   | 0509           |

### **第三个检查点之前：班次0510（5月10日）**

1. **投入**：
   - 新原料：原料番茄批次`456`。
   - 半成品：半成品番茄切片批次`0508`（使用前面班次产出的半成品）。
    
2. **检查点触发（零点）**：
   - 产出：成品沙拉`0510`。
   - 系统记录：
     - `0510`成品 ← `456`（当期原料）、`0508`（半成品）。
      
3. **追溯验证**：
   - 直接追溯：`0510`成品可追溯至原料番茄批次`456`和半成品番茄切片批次`0508`。
   - 间接追溯：因为`0508`半成品可追溯至原料番茄批次`123`和`234`，所以`0510`成品最终可追溯至三个批次的原料番茄。

4. **关联表记录**：

    | 投入批次 | 产出批次 | 类型                    | 关联的来源班次 |
    | -------- | -------- | ----------------------- | -------------- |
    | 456      | 0510     | 原料番茄→成品沙拉     | 0510           |
    | 0508     | 0510     | 半成品番茄切片→成品沙拉 | 0510           |

    以及，因为`0508`半成品切片番茄可追溯至`123`和`234`批次原料，所以其实我们还可以*计算*出这样的间接的关联关系：

    | （间接的）投入批次 | 产出批次 | 类型                    | （间接的）关联的来源班次 |
    | ------------------ | -------- | ----------------------- | ------------------------ |
    | 123                | 0510     | 原料番茄→成品沙拉     | 0510                     |
    | 234                | 0510     | 原料番茄→成品沙拉     | 0510                     |

## 实施注意事项

1. **检查点触发机制**：
   - 可设置自动触发（如每日零点，触发后可能还是需要人工介入确认的）和手动触发两种方式
   - 手动触发适用于特殊情况（如设备维护后、生产流程变更后）

2. **物料结转管理**：
   - 确保结转物料信息完整记录，包括批次号、数量和状态
   - 原料结转应有明确的数量记录，以便准确建立批次关联

3. **批次号生成规范**：
   - 产出品的可读性批次号可以考虑使用"年月日+序号"格式（如`250508001`表示2025年5月8日第1个检查点）
   - 确保批次号全局唯一，避免不同年份的同一日期产生混淆

4. **边界情况处理**：
   - 生产中断：意外中断时应立即触发检查点，记录当前所有物料状态
   - 批次混合：似乎应该避免大量不同批次原料混合使用的情况，这会导致追溯范围的扩大

5. **质量问题追溯**：
   - 出现质量问题时，可通过产出品批次号反向追溯所有相关原料
   - 通过关联关系，也可以迅速确定原料影响的产出品批次

## 总结

检查点批次追溯机制通过在生产过程中设置时间节点，将连续生产转化为离散的班次管理，实现了原料、半成品和成品之间的精确追溯。这种方法具有以下优势：

1. **灵活性**：检查点设置灵活，可根据实际需求调整频率
2. **完整性**：记录所有物料流转关系，包括直接和间接关联
3. **可追溯性**：支持多级追溯，可从最终产品追溯到所有原始投入
4. **易实施**：概念明确，易于在生产系统中实施和管理

通过这种检查点机制，即使在连续生产过程中，也能清晰追踪每批产品所使用的所有原料来源，实现全流程的质量追溯，为食品安全管理和质量控制提供有力支持。


