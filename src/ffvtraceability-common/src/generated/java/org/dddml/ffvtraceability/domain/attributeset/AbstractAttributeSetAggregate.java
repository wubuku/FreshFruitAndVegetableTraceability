// <autogenerated>
//   This file was generated by dddappp code generator.
//   Any changes made to this file manually will be lost next time the file is regenerated.
// </autogenerated>

package org.dddml.ffvtraceability.domain.attributeset;

import java.util.*;
import java.time.OffsetDateTime;
import org.dddml.ffvtraceability.domain.*;
import org.dddml.ffvtraceability.specialization.*;

public abstract class AbstractAttributeSetAggregate extends AbstractAggregate implements AttributeSetAggregate {
    private AttributeSetState.MutableAttributeSetState state;

    private List<Event> changes = new ArrayList<Event>();

    public AbstractAttributeSetAggregate(AttributeSetState state) {
        this.state = (AttributeSetState.MutableAttributeSetState)state;
    }

    public AttributeSetState getState() {
        return this.state;
    }

    public List<Event> getChanges() {
        return this.changes;
    }

    public void create(AttributeSetCommand.CreateAttributeSet c) {
        if (c.getVersion() == null) { c.setVersion(AttributeSetState.VERSION_NULL); }
        AttributeSetEvent e = map(c);
        apply(e);
    }

    public void mergePatch(AttributeSetCommand.MergePatchAttributeSet c) {
        AttributeSetEvent e = map(c);
        apply(e);
    }

    public void throwOnInvalidStateTransition(Command c) {
        AttributeSetCommand.throwOnInvalidStateTransition(this.state, c);
    }

    protected void apply(Event e) {
        onApplying(e);
        state.mutate(e);
        changes.add(e);
    }

    @Override
    protected void onApplying(Event e) {
        if (state.getVersion() == null) {
            state.setTenantId(TenantContext.getTenantId());
        }
        if (e instanceof AttributeSetEvent) {
            AttributeSetEvent ee = (AttributeSetEvent) e;
            ee.setTenantId(state.getTenantId());
        }
        super.onApplying(e);
    }

    protected AttributeSetEvent map(AttributeSetCommand.CreateAttributeSet c) {
        AttributeSetEventId stateEventId = new AttributeSetEventId(c.getAttributeSetId(), c.getVersion());
        AttributeSetEvent.AttributeSetStateCreated e = newAttributeSetStateCreated(stateEventId);
        e.setAttributeSetName(c.getAttributeSetName());
        e.setDescription(c.getDescription());
        ((AbstractAttributeSetEvent)e).setCommandId(c.getCommandId());
        e.setCreatedBy(c.getRequesterId());
        e.setCreatedAt((OffsetDateTime)ApplicationContext.current.getTimestampService().now(OffsetDateTime.class));
        Long version = c.getVersion();
        for (AttributeUseCommand.CreateAttributeUse innerCommand : c.getCreateAttributeUseCommands()) {
            throwOnInconsistentCommands(c, innerCommand);
            AttributeUseEvent.AttributeUseStateCreated innerEvent = mapCreate(innerCommand, c, version, this.state);
            e.addAttributeUseEvent(innerEvent);
        }

        return e;
    }

    protected AttributeSetEvent map(AttributeSetCommand.MergePatchAttributeSet c) {
        AttributeSetEventId stateEventId = new AttributeSetEventId(c.getAttributeSetId(), c.getVersion());
        AttributeSetEvent.AttributeSetStateMergePatched e = newAttributeSetStateMergePatched(stateEventId);
        e.setAttributeSetName(c.getAttributeSetName());
        e.setDescription(c.getDescription());
        e.setIsPropertyAttributeSetNameRemoved(c.getIsPropertyAttributeSetNameRemoved());
        e.setIsPropertyDescriptionRemoved(c.getIsPropertyDescriptionRemoved());
        ((AbstractAttributeSetEvent)e).setCommandId(c.getCommandId());
        e.setCreatedBy(c.getRequesterId());
        e.setCreatedAt((OffsetDateTime)ApplicationContext.current.getTimestampService().now(OffsetDateTime.class));
        Long version = c.getVersion();
        for (AttributeUseCommand innerCommand : c.getAttributeUseCommands()) {
            throwOnInconsistentCommands(c, innerCommand);
            AttributeUseEvent innerEvent = map(innerCommand, c, version, this.state);
            e.addAttributeUseEvent(innerEvent);
        }

        return e;
    }


    protected AttributeUseEvent map(AttributeUseCommand c, AttributeSetCommand outerCommand, Long version, AttributeSetState outerState) {
        AttributeUseCommand.CreateAttributeUse create = (c.getCommandType().equals(CommandType.CREATE)) ? ((AttributeUseCommand.CreateAttributeUse)c) : null;
        if(create != null) {
            return mapCreate(create, outerCommand, version, outerState);
        }

        AttributeUseCommand.MergePatchAttributeUse merge = (c.getCommandType().equals(CommandType.MERGE_PATCH)) ? ((AttributeUseCommand.MergePatchAttributeUse)c) : null;
        if(merge != null) {
            return mapMergePatch(merge, outerCommand, version, outerState);
        }

        throw new UnsupportedOperationException("Unsupported command type: " + c.getCommandType() + " for " + c.getClass().getName());
    }

    protected AttributeUseEvent.AttributeUseStateCreated mapCreate(AttributeUseCommand.CreateAttributeUse c, AttributeSetCommand outerCommand, Long version, AttributeSetState outerState) {
        ((AbstractCommand)c).setRequesterId(outerCommand.getRequesterId());
        AttributeUseEventId stateEventId = new AttributeUseEventId(outerState.getAttributeSetId(), c.getAttributeId(), version);
        AttributeUseEvent.AttributeUseStateCreated e = newAttributeUseStateCreated(stateEventId);
        AttributeUseState s = ((EntityStateCollection.MutableEntityStateCollection<String, AttributeUseState>)outerState.getAttributeUses()).getOrAddDefault(c.getAttributeId());

        e.setSequenceNumber(c.getSequenceNumber());
        e.setCreatedBy(c.getRequesterId());
        e.setCreatedAt((OffsetDateTime)ApplicationContext.current.getTimestampService().now(OffsetDateTime.class));

        return e;

    }// END map(ICreate... ////////////////////////////

    protected AttributeUseEvent.AttributeUseStateMergePatched mapMergePatch(AttributeUseCommand.MergePatchAttributeUse c, AttributeSetCommand outerCommand, Long version, AttributeSetState outerState) {
        ((AbstractCommand)c).setRequesterId(outerCommand.getRequesterId());
        AttributeUseEventId stateEventId = new AttributeUseEventId(outerState.getAttributeSetId(), c.getAttributeId(), version);
        AttributeUseEvent.AttributeUseStateMergePatched e = newAttributeUseStateMergePatched(stateEventId);
        AttributeUseState s = ((EntityStateCollection.MutableEntityStateCollection<String, AttributeUseState>)outerState.getAttributeUses()).getOrAddDefault(c.getAttributeId());

        e.setSequenceNumber(c.getSequenceNumber());
        e.setIsPropertySequenceNumberRemoved(c.getIsPropertySequenceNumberRemoved());

        e.setCreatedBy(c.getRequesterId());
        e.setCreatedAt((OffsetDateTime)ApplicationContext.current.getTimestampService().now(OffsetDateTime.class));

        return e;

    }// END map(IMergePatch... ////////////////////////////

    protected void throwOnInconsistentCommands(AttributeSetCommand command, AttributeUseCommand innerCommand) {
        AbstractAttributeSetCommand properties = command instanceof AbstractAttributeSetCommand ? (AbstractAttributeSetCommand) command : null;
        AbstractAttributeUseCommand innerProperties = innerCommand instanceof AbstractAttributeUseCommand ? (AbstractAttributeUseCommand) innerCommand : null;
        if (properties == null || innerProperties == null) { return; }
        String outerAttributeSetIdName = "AttributeSetId";
        String outerAttributeSetIdValue = properties.getAttributeSetId();
        String innerAttributeSetIdName = "AttributeSetId";
        String innerAttributeSetIdValue = innerProperties.getAttributeSetId();
        if (innerAttributeSetIdValue == null) {
            innerProperties.setAttributeSetId(outerAttributeSetIdValue);
        }
        else if (innerAttributeSetIdValue != outerAttributeSetIdValue 
            && (innerAttributeSetIdValue == null || innerAttributeSetIdValue != null && !innerAttributeSetIdValue.equals(outerAttributeSetIdValue))) {
            throw DomainError.named("inconsistentId", "Outer %1$s %2$s NOT equals inner %3$s %4$s", outerAttributeSetIdName, outerAttributeSetIdValue, innerAttributeSetIdName, innerAttributeSetIdValue);
        }
    }// END throwOnInconsistentCommands /////////////////////


    ////////////////////////

    protected AttributeSetEvent.AttributeSetStateCreated newAttributeSetStateCreated(Long version, String commandId, String requesterId) {
        AttributeSetEventId stateEventId = new AttributeSetEventId(this.state.getAttributeSetId(), version);
        AttributeSetEvent.AttributeSetStateCreated e = newAttributeSetStateCreated(stateEventId);
        ((AbstractAttributeSetEvent)e).setCommandId(commandId);
        e.setCreatedBy(requesterId);
        e.setCreatedAt((OffsetDateTime)ApplicationContext.current.getTimestampService().now(OffsetDateTime.class));
        return e;
    }

    protected AttributeSetEvent.AttributeSetStateMergePatched newAttributeSetStateMergePatched(Long version, String commandId, String requesterId) {
        AttributeSetEventId stateEventId = new AttributeSetEventId(this.state.getAttributeSetId(), version);
        AttributeSetEvent.AttributeSetStateMergePatched e = newAttributeSetStateMergePatched(stateEventId);
        ((AbstractAttributeSetEvent)e).setCommandId(commandId);
        e.setCreatedBy(requesterId);
        e.setCreatedAt((OffsetDateTime)ApplicationContext.current.getTimestampService().now(OffsetDateTime.class));
        return e;
    }

    protected AttributeSetEvent.AttributeSetStateCreated newAttributeSetStateCreated(AttributeSetEventId stateEventId) {
        return new AbstractAttributeSetEvent.SimpleAttributeSetStateCreated(stateEventId);
    }

    protected AttributeSetEvent.AttributeSetStateMergePatched newAttributeSetStateMergePatched(AttributeSetEventId stateEventId) {
        return new AbstractAttributeSetEvent.SimpleAttributeSetStateMergePatched(stateEventId);
    }

    protected AttributeUseEvent.AttributeUseStateCreated newAttributeUseStateCreated(AttributeUseEventId stateEventId) {
        return new AbstractAttributeUseEvent.SimpleAttributeUseStateCreated(stateEventId);
    }

    protected AttributeUseEvent.AttributeUseStateMergePatched newAttributeUseStateMergePatched(AttributeUseEventId stateEventId) {
        return new AbstractAttributeUseEvent.SimpleAttributeUseStateMergePatched(stateEventId);
    }


    public static class SimpleAttributeSetAggregate extends AbstractAttributeSetAggregate {
        public SimpleAttributeSetAggregate(AttributeSetState state) {
            super(state);
        }

    }

}

